From 458b39ce63d3eb1ae67a4f80a74248f73aa38680 Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@solus-project.com>
Date: Sun, 7 Aug 2016 23:16:27 +0100
Subject: [PATCH] Only attempt to use GNOME Shell settings when using GNOME
 Shell

Signed-off-by: Ikey Doherty <ikey@solus-project.com>
---
 src/gcal-year-view.c | 17 ++++++++++++-----
 1 file changed, 12 insertions(+), 5 deletions(-)

diff --git a/src/gcal-year-view.c b/src/gcal-year-view.c
index 60b061c..e9eb5f6 100644
--- a/src/gcal-year-view.c
+++ b/src/gcal-year-view.c
@@ -1099,7 +1099,9 @@ gcal_year_view_finalize (GObject *object)
 
   g_clear_pointer (&year_view->date, g_free);
 
-  g_clear_object (&year_view->shell_settings);
+  if (year_view->shell_settings) {
+    g_clear_object (&year_view->shell_settings);
+  }
 
   G_OBJECT_CLASS (gcal_year_view_parent_class)->finalize (object);
 }
@@ -1486,6 +1488,8 @@ gcal_year_view_class_init (GcalYearViewClass *klass)
 static void
 gcal_year_view_init (GcalYearView *self)
 {
+  const gchar *env = NULL;
+
   gtk_widget_init_template (GTK_WIDGET (self));
 
   if (gtk_widget_get_direction (GTK_WIDGET (self)) == GTK_TEXT_DIR_LTR)
@@ -1501,10 +1505,13 @@ gcal_year_view_init (GcalYearView *self)
   self->end_selected_date = g_new0 (icaltimetype, 1);
   self->end_selected_date->zone = e_cal_util_get_system_timezone ();
 
-  /* bind GNOME Shell' show week numbers property to GNOME Calendar's one */
-  self->shell_settings = g_settings_new ("org.gnome.shell.calendar");
-  g_settings_bind (self->shell_settings, "show-weekdate", self, "show-week-numbers", G_SETTINGS_BIND_DEFAULT);
-  g_signal_connect_swapped (self->shell_settings, "changed::show-weekdate", G_CALLBACK (gtk_widget_queue_draw), self);
+  env = g_getenv("XDG_CURRENT_DESKTOP");
+  if (g_str_equal(env, "GNOME")) {
+      /* bind GNOME Shell' show week numbers property to GNOME Calendar's one */
+      self->shell_settings = g_settings_new ("org.gnome.shell.calendar");
+      g_settings_bind (self->shell_settings, "show-weekdate", self, "show-week-numbers", G_SETTINGS_BIND_DEFAULT);
+      g_signal_connect_swapped (self->shell_settings, "changed::show-weekdate", G_CALLBACK (gtk_widget_queue_draw), self);
+  }
 
   gtk_list_box_set_header_func (GTK_LIST_BOX (self->events_sidebar), update_sidebar_headers, self, NULL);
   gtk_list_box_set_sort_func (GTK_LIST_BOX (self->events_sidebar), sidebar_sort_func, NULL, NULL);
-- 
2.9.2

